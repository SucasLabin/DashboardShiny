---
title: "üìò An√°lise Comparativa de PM‚ÇÇ.‚ÇÖ ‚Äî CAMS x DON nos Munic√≠pios do Par√°"
author: "Lucas Sabino"
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
  html_document:
    theme: flatly        # tema clean e colorido
    highlight: tango     # destaque de c√≥digo suave
    toc: true            # adiciona sum√°rio lateral
    toc_float: true
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
# Configura√ß√µes globais
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6
)

# Paleta viridis padr√£o (plasma)
library(viridis)
paleta_pm25 <- viridis(5, option = "plasma")

# Tema geral para gr√°ficos
library(ggplot2)
theme_set(theme_minimal(base_size = 13))
```

```{r, echo=FALSE, include=F, warning=FALSE}
### setar diretorio ###
{
  setwd('C:/Users/lucky/Desktop/UFF/Est. Comp. II/DashShiny')
}

### bibliotecas ###

suppressPackageStartupMessages({
  library(tidyverse)
  library(ggplot2)
  library(geobr)
  library(lubridate)
  library(patchwork)
  library(reshape2)
  library(ggpubr)
  library(GGally)
  library(readxl)
  library(sf)
  library(viridis)
  library(ggpubr)
  library(kableExtra)
})

### importacao ###
{
  dadoscams2023<-read.csv2("daily_pm25_all_regions_2023.csv")
  dadoscams2022<-read.csv2("daily_pm25_all_regions_2022.csv")
  
  dadosdon2023<-read_xlsx("Donkelar_dados_completos_consolidado_2023.xlsx")  
  dadosdon2022<-read_xlsx("Donkelar_dados_completos_consolidado_2022.xlsx")
}

### bases para / UF = PA / Cod = 15 ###
{
base_total <- rbind(dadosdon2022, dadosdon2023)
base_don <- base_total |> dplyr::filter(SIGLA_UF %in% c('15', 'PA'))

long=melt(dadoscams2023, id.vars="Date")
colnames(long)=c("Date","CodRes","pm2.5")
long$Cod=substring(long$CodRes, 4,10)
long$Cod2=substring(long$Cod, 1,6)
long$UF=substring(long$Cod, 1,2)
long$Date2=dmy(long$Date)
long$ano=year(long$Date2)
long$month=month(long$Date2)

long_22=melt(dadoscams2022, id.vars="Date")
colnames(long_22)=c("Date","CodRes","pm2.5")
long_22$Cod=substring(long_22$CodRes, 4,10)
long_22$Cod2=substring(long_22$Cod, 1,6)
long_22$UF=substring(long_22$Cod, 1,2)
long_22$Date2=ymd(long_22$Date)
long_22$ano=year(long_22$Date2)
long_22$month=month(long_22$Date2)

base_cams <- rbind(long, long_22)
base_cams <- base_cams |> dplyr::filter(UF == '15')
base_cams$CodRes <- str_remove(base_cams$CodRes, 'ID_')

rm(base_total, dadoscams2022, dadoscams2023, dadosdon2022, dadosdon2023, long, long_22)
}
```

```{r, echo=FALSE, include=F, warning=FALSE}
### 1 ### municipio_mes
{
  cams_municipio_mes <- base_cams %>%    
    group_by(CodRes, month) %>%
    summarise(pm2.5_mean = mean(`pm2.5`, na.rm = TRUE),
              pm2.5_sd   = sd(`pm2.5`, na.rm = TRUE),
              n_obs      = n()) %>%
    ungroup()
  
  don_municipio_mes <- base_don %>%
    group_by(NM_MUN, Mes) %>%
    summarise(
      Media_PM25 = mean(Media_PM25, na.rm = TRUE),
      Desvio_Padrao_PM25 = sd(Media_PM25, na.rm = TRUE),
      Min_PM25 = min(Min_PM25, na.rm = TRUE),
      Max_PM25 = max(Max_PM25, na.rm = TRUE),
      n_obs = n()
    ) %>%
    ungroup()
  
}

### 2 ### estado_mes_ano
{
  cams_estado_mes_ano <- base_cams %>%
    group_by(UF, ano, month) %>%
    summarise(pm2.5_mean = mean(`pm2.5`, na.rm = TRUE),
              pm2.5_sd   = sd(`pm2.5`, na.rm = TRUE),
              n_obs      = n()) %>%
    ungroup()
  
  don_estado_mes_ano <- base_don %>%
    group_by(SIGLA_UF, Ano, Mes) %>%
    summarise(
      Media_PM25 = mean(Media_PM25, na.rm = TRUE),
      Desvio_Padrao_PM25 = sd(Media_PM25, na.rm = TRUE),
      Min_PM25 = min(Min_PM25, na.rm = TRUE),
      Max_PM25 = max(Max_PM25, na.rm = TRUE),
      n_obs = n()
    ) %>%
    ungroup()
  
}

### 3 ### municipio_ano
{
  cams_municipio_ano <- base_cams %>%
    group_by(CodRes, ano) %>%
    summarise(pm2.5_mean = mean(`pm2.5`, na.rm = TRUE),
              pm2.5_sd   = sd(`pm2.5`, na.rm = TRUE),
              n_obs      = n()) %>%
    ungroup()
  
  don_municipio_ano <- base_don %>%
    group_by(CD_MUN, NM_MUN, Ano) %>%
    summarise(
      Media_PM25 = mean(Media_PM25, na.rm = TRUE),
      Desvio_Padrao_PM25 = sd(Media_PM25, na.rm = TRUE),
      Min_PM25 = min(Min_PM25, na.rm = TRUE),
      Max_PM25 = max(Max_PM25, na.rm = TRUE),
      n_obs = n()
    ) %>%
    ungroup()
}

mun_shp <- read_municipality(year = 2020, showProgress = T)

```

# üß© Introdu√ß√£o

A qualidade do ar √© um tema central nas discuss√µes sobre sa√∫de p√∫blica e sustentabilidade ambiental. Entre os diversos poluentes atmosf√©ricos, o material particulado fino (PM‚ÇÇ.‚ÇÖ) ‚Äî part√≠culas com di√¢metro inferior a 2,5 micr√¥metros ‚Äî √© um dos mais cr√≠ticos, devido √† sua capacidade de penetrar profundamente no sistema respirat√≥rio humano e causar diversos agravos √† sa√∫de, como doen√ßas respirat√≥rias e cardiovasculares.

Neste estudo, foram analisados dados de concentra√ß√£o de PM2.5 referentes a munic√≠pios do estado do Par√°, uma regi√£o caracterizada por intensa atividade agropecu√°ria, ocorr√™ncia de queimadas sazonais e variabilidade clim√°tica marcante, fatores que influenciam diretamente a qualidade do ar.

O objetivo principal deste estudo √© comparar as estimativas de concentra√ß√£o de PM‚ÇÇ.‚ÇÖ obtidas a partir de duas fontes de dados distintas:

-   CAMS (Copernicus Atmosphere Monitoring Service), que fornece estimativas modeladas com base em observa√ß√µes satelitais e assimila√ß√£o de dados atmosf√©ricos globais; e

-   DON, sigla utilizada neste trabalho para representar a base Donkelar, que re√∫ne dados observacionais consolidados de medi√ß√µes locais de qualidade do ar.

A an√°lise visa avaliar o grau de concord√¢ncia entre as fontes, identificar padr√µes sazonais e testar estatisticamente se, em m√©dia, as estimativas do CAMS diferem de forma significativa dos valores observacionais reportados pela base Donkelar (DON).

# ‚öôÔ∏è Metodologia

## Fontes de Dados e Processamento

```{r, warning=F,   echo=F}
tabela_metodologia <- tibble(
  "Etapa" = c("Coleta de Dados", "Pr√©-processamento", "An√°lise Explorat√≥ria", 
              "An√°lise Estat√≠stica", "Visualiza√ß√£o"),
  "Descri√ß√£o" = c(
    "Dados di√°rios de PM‚ÇÇ.‚ÇÖ do CAMS (2022-2023) e dados mensais da base DON",
    "Padroniza√ß√£o de vari√°veis, filtragem para MT e cria√ß√£o de agregados temporais",
    "Mapas de distribui√ß√£o, boxplots sazonais e s√©ries temporais",
    "C√°lculo de diferen√ßas mensais e an√°lise de concord√¢ncia",
    "Gera√ß√£o de visualiza√ß√µes comparativas com tema unificado"
  ),
  "Ferramentas" = c("readr, readxl", "dplyr, lubridate", "ggplot2, sf", 
                    "Estat√≠stica descritiva", "patchwork, viridis")
)

kbl(tabela_metodologia, caption = "Fluxo de trabalho metodol√≥gico") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Abordagem Anal√≠tica

1.  Harmoniza√ß√£o dos dados: Padroniza√ß√£o de vari√°veis e unidades entre as fontes

2.  Transforma√ß√£o logar√≠tmica: Aplica√ß√£o de log‚ÇÅ‚Çö(PM‚ÇÇ.‚ÇÖ) = log(PM‚ÇÇ.‚ÇÖ + 1) para reduzir assimetria

3.  An√°lise explorat√≥ria:

-   Mapas de distribui√ß√£o espacial
-   Boxplots mensais comparativos
-   S√©ries temporais de diferen√ßas

4.  An√°lise estat√≠stica: Testes de hip√≥tese para diferen√ßas sistem√°ticas

# üìä Resultados e Discuss√£o

## Distribui√ß√£o Espacial das Concentra√ß√µes M√©dias

```{r, echo=FALSE, warning=FALSE}
mun_shp <- mun_shp |> 
  dplyr::filter(stringr::str_detect(code_muni, '15')) |> 
  mutate(code_muni = as.character(code_muni)) |>
  slice(8:151)

### GERAL ###

mapa_cams <- mun_shp %>%
  left_join(cams_municipio_ano, by = c("code_muni" = "CodRes"))

mapa_don <- mun_shp %>%
  left_join(don_municipio_ano, by = c("code_muni" = "CD_MUN"))

mapa_diff <- tibble(pm25_mean = mapa_don$Media_PM25 - mapa_cams$pm2.5_mean,
                    geom = mapa_cams$geom) |> 
  sf::st_sf(sf_column_name = "geom")

limites_comuns <- range(
  c(mapa_cams$pm2.5_mean, mapa_don$Media_PM25),
  na.rm = TRUE
)

p2 <- ggplot(mapa_cams) +
  geom_sf(aes(fill = pm2.5_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "CAMS", fill = "PM2.5") +
  theme_minimal()

p1 <- ggplot(mapa_don) +
  geom_sf(aes(fill = Media_PM25), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "DON", fill = "PM2.5") +
  theme_minimal()

p3 <- ggplot(mapa_diff) +
  geom_sf(aes(fill = pm25_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(title = "Diferen√ßa de PM2.5 DON ‚àí CAMS (¬µg/m¬≥)", fill = "Dif. (¬µg/m¬≥)") +
  theme_minimal()

#(p1 | p2 | p3) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p <- (p1 | p2) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p3 <- p3 + theme(legend.position = "bottom")
p3|p
```

O mapa mostra a distribui√ß√£o m√©dia de PM2.5 (¬µg/m¬≥) estimada pelas fontes **DON (Donkelar)** e **CAMS**, al√©m da diferen√ßa entre elas (DON ‚àí CAMS). Observa-se **boa concord√¢ncia geral** entre as duas bases, com as **maiores concentra√ß√µes nas regi√µes central e sudeste** e valores menores no norte do territ√≥rio.

No mapa de diferen√ßas, **a maior parte dos munic√≠pios apresenta valores pr√≥ximos de zero**, indicando consist√™ncia entre as estimativas. Contudo, **√°reas amareladas** revelam locais onde o **DON estimou concentra√ß√µes mais altas que o CAMS**, com destaque para o **munic√≠pio de Trair√£o (PA)**, que apresenta a **diferen√ßa positiva mais acentuada**. Essa discrep√¢ncia pode refletir **condi√ß√µes locais de emiss√£o** ou **diferen√ßas na resolu√ß√£o espacial** dos modelos utilizados.

```{r, echo=FALSE, warning=FALSE}
  ### 2022 ###
ano_plot <- 2022

mapa_cams_22 <- mapa_cams %>% filter(ano == ano_plot)
mapa_don_22 <- mapa_don %>% filter(Ano == ano_plot)

mapa_diff_22 <- tibble(
  pm25_mean = mapa_don_22$Media_PM25 - mapa_cams_22$pm2.5_mean,
  geom = mapa_cams_22$geom
) |> sf::st_sf(sf_column_name = "geom")

limites_comuns <- range(
  c(mapa_cams_22$pm2.5_mean, mapa_don_22$Media_PM25),
  na.rm = TRUE
)

p2 <- ggplot(mapa_cams_22) +
  geom_sf(aes(fill = pm2.5_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "CAMS 2022", fill = "PM2.5") +
  theme_minimal()

p1 <- ggplot(mapa_don_22) +
  geom_sf(aes(fill = Media_PM25), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "DON 2022", fill = "PM2.5") +
  theme_minimal()

p3 <- ggplot(mapa_diff_22) +
  geom_sf(aes(fill = pm25_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(title = "Diferen√ßa 2022 (DON ‚àí CAMS)", fill = "¬µg/m¬≥") +
  theme_minimal()

#(p1 | p2 | p3) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p <- (p1 | p2) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p3 <- p3 + theme(legend.position = "bottom")
p3|p
```

O mapa apresenta as diferen√ßas anuais de concentra√ß√£o m√©dia de PM2.5 (¬µg/m¬≥) entre as fontes **DON (Donkelar)** e **CAMS (Copernicus)** no ano de 2022. De modo geral, observa-se **boa correspond√™ncia espacial entre as duas estimativas**, embora existam discrep√¢ncias pontuais em algumas √°reas do sudoeste do Par√°.

Os tons **amarelados** indicam locais onde o **DON estimou concentra√ß√µes mais altas** que o CAMS, enquanto os **tons azulados** representam o inverso. Destacam-se dois munic√≠pios: **Itaituba**, que apresenta uma **diferen√ßa positiva expressiva** (DON \> CAMS), sugerindo estimativas mais elevadas de PM2.5 pela base Donkelar; e **Novo Progresso**, onde ocorre o oposto ‚Äî uma **diferen√ßa negativa** (DON \< CAMS), indicando valores maiores no CAMS.

Essas varia√ß√µes locais podem estar associadas a **condi√ß√µes espec√≠ficas de emiss√£o**, intensidade de queimadas ou diferen√ßas na **resolu√ß√£o espacial e nos m√©todos de interpola√ß√£o** entre as fontes. Apesar dessas diverg√™ncias pontuais, o padr√£o geral refor√ßa a **coer√™ncia global entre DON e CAMS** na representa√ß√£o da distribui√ß√£o espacial de PM‚ÇÇ.‚ÇÖ para o ano de 2022.

```{r, echo=FALSE, warning=FALSE}
    ### 2023 ###
ano_plot <- 2023

mapa_cams_23 <- mapa_cams %>% filter(ano == ano_plot)
mapa_don_23 <- mapa_don %>% filter(Ano == ano_plot)

mapa_diff_23 <- tibble(
  pm25_mean = mapa_don_23$Media_PM25 - mapa_cams_23$pm2.5_mean,
  geom = mapa_cams_22$geom
) |> sf::st_sf(sf_column_name = "geom")

limites_comuns <- range(
  c(mapa_cams_23$pm2.5_mean, mapa_don_23$Media_PM25),
  na.rm = TRUE
)

p2 <- ggplot(mapa_cams_23) +
  geom_sf(aes(fill = pm2.5_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "CAMS 2023", fill = "PM2.5") +
  theme_minimal()

p1 <- ggplot(mapa_don_23) +
  geom_sf(aes(fill = Media_PM25), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90", limits = limites_comuns) +
  labs(title = "DON 2023", fill = "PM2.5") +
  theme_minimal()

p3 <- ggplot(mapa_diff_23) +
  geom_sf(aes(fill = pm25_mean), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(title = "Diferen√ßa 2023 (DON ‚àí CAMS)", fill = "¬µg/m¬≥") +
  theme_minimal()

#(p1 | p2 | p3) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p <- (p1 | p2) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
p3 <- p3 + theme(legend.position = "bottom")
p3|p
```

O mapa apresenta as diferen√ßas m√©dias anuais de PM‚ÇÇ.‚ÇÖ (¬µg/m¬≥) entre as bases **DON (Donkelar)** e **CAMS (Copernicus)** para o ano de 2023. Em termos gerais, observa-se **boa correspond√™ncia entre as duas fontes**, com a maior parte dos munic√≠pios apresentando diferen√ßas pr√≥ximas de zero.

As **√°reas amareladas** indicam onde o **DON estimou valores mais altos de PM‚ÇÇ.‚ÇÖ**, enquanto as **√°reas azuladas** mostram locais em que o **CAMS apresentou concentra√ß√µes superiores**. Destaca-se o munic√≠pio de **Novo Progresso (PA)**, novamente evidenciado em **amarelo intenso**, indicando uma **diferen√ßa positiva expressiva (DON \> CAMS)**. Esse resultado sugere que, em 2023, o DON captou n√≠veis mais elevados de material particulado nessa regi√£o, possivelmente associados √† **ocorr√™ncia de queimadas ou fontes locais de emiss√£o**.

No restante do territ√≥rio, as diferen√ßas se mant√™m sutis, refor√ßando a **consist√™ncia geral entre os conjuntos de dados** e a estabilidade do padr√£o espacial observado em rela√ß√£o ao ano anterior (2022).

## An√°lise das distribui√ß√µes mensais ‚Äî Boxplots

Com o objetivo de comparar as concentra√ß√µes mensais de PM2.5 estimadas pelas fontes DON (Donkelar) e CAMS (Copernicus), foram elaborados boxplots representando a distribui√ß√£o dos valores ao longo de cada m√™s e ano analisado. Essa abordagem permite observar a varia√ß√£o intra e interanual dos dados, bem como poss√≠veis diferen√ßas sistem√°ticas entre as duas fontes.

Inicialmente, o boxplot foi constru√≠do utilizando os valores originais de PM2.5 (¬µg/m¬≥). No entanto, verificou-se a presen√ßa de um grande n√∫mero de outliers, o que dificultou a visualiza√ß√£o dos padr√µes centrais e a compara√ß√£o entre os meses. Esses valores extremos refletem a alta variabilidade espacial das concentra√ß√µes, especialmente em regi√µes com ocorr√™ncia pontual de queimadas intensas.

Para contornar essa limita√ß√£o, foi aplicado um ajuste logar√≠tmico √†s observa√ß√µes, por meio da transforma√ß√£o log(x + 1). Essa transforma√ß√£o reduziu a amplitude dos valores, diminuindo a influ√™ncia dos outliers e permitindo uma visualiza√ß√£o mais equilibrada das distribui√ß√µes mensais. Com isso, tornou-se poss√≠vel identificar com maior clareza as tend√™ncias de varia√ß√£o entre meses e entre fontes, preservando a estrutura relativa dos dados.

### Visao Geral

```{r, echo=FALSE, warning=FALSE}
### dados a serem plotados ###
  base_cams_sel <- base_cams %>%
    select(month, `pm2.5`, ano) %>%
    mutate(Fonte = "CAMS",
           #Valor_PM25 = log1p(`pm2.5`))  # transforma√ß√£o log(x+1)
           Valor_PM25 = `pm2.5`)
  
  base_don_sel <- base_don %>%
    select(Mes, Media_PM25, Ano) %>%
    rename(month = Mes,
           ano = Ano) %>%
    mutate(Fonte = "DON",
           Valor_PM25 = Media_PM25)
           #Valor_PM25 = log1p(`Media_PM25`)) # log(x+1)
  
           
  dados_plot <- bind_rows(
    base_cams_sel %>% select(month, Fonte, Valor_PM25, ano),
    base_don_sel %>% select(month, Fonte, Valor_PM25, ano))

  ### Geral ###
  ggplot(dados_plot, aes(x = factor(month), y = Valor_PM25, fill = Fonte)) +
    geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
    scale_fill_manual(values = c("CAMS" = "#8B008B", "DON" = "#FF8C00")) +
    labs(
      x = "M√™s",
      y = "PM2.5 (¬µg/m¬≥)",
      fill = "Fonte"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "top"
    )
```

Para comparar as concentra√ß√µes mensais de PM‚ÇÇ.‚ÇÖ das fontes CAMS e DON, utilizou-se a representa√ß√£o por boxplots. Inicialmente, a an√°lise com os dados originais foi prejudicada pela alta frequ√™ncia de outliers, resultantes da variabilidade espacial inerente aos dados, particularmente de eventos pontuais como queimadas. Para contornar esse obst√°culo e permitir uma visualiza√ß√£o mais clara dos padr√µes de distribui√ß√£o, optou-se por aplicar uma transforma√ß√£o logar√≠tmica na forma de log(PM2.5 + 1) aos dados.

```{r, echo=FALSE, warning=FALSE}
### dados a serem plotados ###
  base_cams_sel <- base_cams %>%
    select(month, `pm2.5`, ano) %>%
    mutate(Fonte = "CAMS",
           Valor_PM25 = log1p(`pm2.5`))  # transforma√ß√£o log(x+1)
           #Valor_PM25 = `pm2.5`)
  
  base_don_sel <- base_don %>%
    select(Mes, Media_PM25, Ano) %>%
    rename(month = Mes,
           ano = Ano) %>%
    mutate(Fonte = "DON",
           #Valor_PM25 = Media_PM25)
           Valor_PM25 = log1p(`Media_PM25`)) # log(x+1)
  
           
  dados_plot <- bind_rows(
    base_cams_sel %>% select(month, Fonte, Valor_PM25, ano),
    base_don_sel %>% select(month, Fonte, Valor_PM25, ano))

  ### Geral ###
  ggplot(dados_plot, aes(x = factor(month), y = Valor_PM25, fill = Fonte)) +
    geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
    scale_fill_manual(values = c("CAMS" = "#8B008B", "DON" = "#FF8C00")) +
    labs(
      x = "M√™s",
      y = "PM2.5 (¬µg/m¬≥)",
      fill = "Fonte"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "top"
    )
```

Os boxplots resultantes, ap√≥s a transforma√ß√£o, revelam um padr√£o sazonal consistente entre ambas as fontes, com um aumento caracter√≠stico das concentra√ß√µes de PM‚ÇÇ.‚ÇÖ durante os meses de inverno e seca (por exemplo, de maio a setembro). Esse comportamento confirma a influ√™ncia esperada da sazonalidade clim√°tica e do regime de queimadas na qualidade do ar. A similaridade no padr√£o temporal entre CAMS e DON valida a capacidade de ambas em capturar a din√¢mica sazonal principal do poluente.

### Visao Anual

```{r, echo=FALSE, warning=FALSE}
 ### 2022 ###
  
  dados_ano <- dados_plot %>%
    filter(ano == 2022)
  
  p1 <- ggplot(dados_ano, aes(x = factor(month), y = Valor_PM25, fill = Fonte)) +
    geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
    scale_fill_manual(values = c("CAMS" = "#8B008B", "DON" = "#FF8C00")) +
    labs(
      title = "Distribui√ß√£o mensal de PM2.5 por fonte de dados - 2022",
      x = "M√™s",
      y = "PM2.5 (¬µg/m¬≥)",
      fill = "Fonte"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "top"
    )
  
  ### 2023 ###
  
  dados_ano <- dados_plot %>%
    filter(ano == 2023)
  
  p2 <- ggplot(dados_ano, aes(x = factor(month), y = Valor_PM25, fill = Fonte)) +
    geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
    scale_fill_manual(values = c("CAMS" = "#8B008B", "DON" = "#FF8C00")) +
    labs(
      title = "Distribui√ß√£o mensal de PM2.5 por fonte de dados - 2023",
      x = "M√™s",
      y = "PM2.5 (¬µg/m¬≥)",
      fill = "Fonte"
    ) +
    theme_minimal(base_size = 13) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "top"
    )
  
p1/p2
  
```

# üìà An√°lise de Correla√ß√£o e Concord√¢ncia

```{r, warning=FALSE, echo=FALSE}
# Criar base consolidada por munic√≠pio e ano (m√©dias anuais)

base_merge <- st_drop_geometry(mapa_cams) %>%
     select(code_muni, ano, pm2.5_mean) %>%
     rename(PM25_CAMS = pm2.5_mean) %>%
     inner_join(
         st_drop_geometry(mapa_don) %>%
             select(code_muni, Ano, Media_PM25) %>%
             rename(PM25_DON = Media_PM25, ano = Ano),
         by = c("code_muni", "ano")
     ) %>%
     drop_na(PM25_CAMS, PM25_DON)

```

## üîπ C√°lculo das correla√ß√µes

```{r, warning=FALSE, echo=FALSE}
cor_pearson <- cor(base_merge$PM25_CAMS, base_merge$PM25_DON, method = "pearson")
cor_spearman <- cor(base_merge$PM25_CAMS, base_merge$PM25_DON, method = "spearman")

tabela_cor <- tibble(
"M√©todo" = c("Pearson", "Spearman"),
"Correla√ß√£o" = c(round(cor_pearson, 3), round(cor_spearman, 3)),
"Interpreta√ß√£o" = c(
ifelse(cor_pearson > 0.8, "Correla√ß√£o muito forte",
ifelse(cor_pearson > 0.6, "Correla√ß√£o moderada", "Correla√ß√£o fraca")),
ifelse(cor_spearman > 0.8, "Correla√ß√£o muito forte",
ifelse(cor_spearman > 0.6, "Correla√ß√£o moderada", "Correla√ß√£o fraca"))
)
)

kbl(tabela_cor, caption = "Coeficientes de Correla√ß√£o entre CAMS e DON") %>%
kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

Correla√ß√£o de Pearson (r = 0,75): indica uma associa√ß√£o linear moderada a forte entre as duas bases. Em geral, quando os valores do CAMS aumentam, os valores do DON tamb√©m aumentam. Isso sugere que as duas fontes captam de forma semelhante as varia√ß√µes espaciais e/ou temporais da concentra√ß√£o de PM‚ÇÇ.‚ÇÖ.

Correla√ß√£o de Spearman (œÅ = 0,79): mede a correla√ß√£o por postos (ordem dos valores). Como √© um pouco maior, mostra que, mesmo que a rela√ß√£o n√£o seja perfeitamente linear, a ordem dos munic√≠pios/anos com maiores e menores concentra√ß√µes √© consistente entre as duas bases.

## üîπ Gr√°fico de Dispers√£o

```{r, warning=FALSE, echo=FALSE}

ggplot(base_merge, aes(x = PM25_CAMS, y = PM25_DON)) +
geom_point(alpha = 0.6, color = "#8B008B") +
geom_smooth(method = "lm", se = TRUE, color = "orange", linewidth = 1) +
annotate("text", x = Inf, y = -Inf, hjust = 1.1, vjust = -0.5,
label = paste0("r = ", round(cor_pearson, 2)),
size = 5, color = "darkblue") +
labs(
title = "Dispers√£o entre estimativas de PM2.5 ‚Äî CAMS vs DON",
x = "CAMS (¬µg/m¬≥)",
y = "DON (¬µg/m¬≥)"
) +
theme_minimal(base_size = 13)
```

O ajuste linear (linha laranja) mostra uma tend√™ncia positiva clara: os pontos est√£o pr√≥ximos da linha, embora com alguma dispers√£o, principalmente em n√≠veis mais altos de PM‚ÇÇ.‚ÇÖ.

A nuvem de pontos √© concentrada entre 10 e 25 ¬µg/m¬≥, o que √© coerente com os valores t√≠picos observados na regi√£o.

O coeficiente mostrado no canto (‚Äúr = 0.75‚Äù) refor√ßa visualmente essa correla√ß√£o moderada.

## üîπ Gr√°fico de Bland‚ÄìAltman

```{r, warning=FALSE, echo=FALSE}

#O gr√°fico de Bland‚ÄìAltman avalia a concord√¢ncia entre duas medi√ß√µes, mostrando a diferen√ßa entre elas em fun√ß√£o da m√©dia.

#Calcular diferen√ßas e m√©dias

base_merge <- base_merge %>%
mutate(
media_pares = (PM25_CAMS + PM25_DON) / 2,
diff = PM25_DON - PM25_CAMS
)

mean_diff <- mean(base_merge$diff, na.rm = TRUE)
sd_diff <- sd(base_merge$diff, na.rm = TRUE)
limite_inferior <- mean_diff - 1.96 * sd_diff
limite_superior <- mean_diff + 1.96 * sd_diff

ggplot(base_merge, aes(x = media_pares, y = diff)) +
geom_point(alpha = 0.6, color = "#1f77b4") +
geom_hline(yintercept = mean_diff, color = "darkred", linetype = "solid") +
geom_hline(yintercept = limite_inferior, color = "gray50", linetype = "dashed") +
geom_hline(yintercept = limite_superior, color = "gray50", linetype = "dashed") +
labs(
title = "Gr√°fico de Bland‚ÄìAltman ‚Äî Concord√¢ncia entre CAMS e DON",
x = "M√©dia das estimativas (¬µg/m¬≥)",
y = "Diferen√ßa (DON ‚àí CAMS, ¬µg/m¬≥)"
) +
theme_minimal(base_size = 13)
```

O gr√°fico de Bland‚ÄìAltman indica boa concord√¢ncia entre CAMS e DON, com vi√©s m√©dio pr√≥ximo de zero e diferen√ßas dentro de limites aceit√°veis para a maioria dos munic√≠pios. Pequenas diverg√™ncias em n√≠veis mais altos de PM‚ÇÇ.‚ÇÖ sugerem que as fontes mant√™m consist√™ncia geral, mas podem divergir sob condi√ß√µes extremas de concentra√ß√£o atmosf√©rica.

##üîπ Medida de Concord√¢ncia (Lin‚Äôs CCC)

```{r, warning=FALSE, echo=FALSE}

if (!requireNamespace("DescTools", quietly = TRUE)) {
install.packages("DescTools")
}
library(DescTools)

ccc <- CCC(base_merge$PM25_DON, base_merge$PM25_CAMS, ci = "z-transform")
tabela_ccc <- tibble(
"Estat√≠stica" = c("Concordance Correlation Coefficient (Lin‚Äôs CCC)",
"Limite inferior 95%", "Limite superior 95%"),
"Valor" = c(round(ccc$rho.c[,1], 3),
round(ccc$rho.c[,2], 3),
round(ccc$rho.c[,3], 3)),
"Interpreta√ß√£o" = c(
ifelse(ccc$rho.c[,1] > 0.9, "Concord√¢ncia quase perfeita",
ifelse(ccc$rho.c[,1] > 0.8, "Concord√¢ncia substancial",
ifelse(ccc$rho.c[,1] > 0.6, "Concord√¢ncia moderada", "Concord√¢ncia fraca"))),
"", ""
)
)

kbl(tabela_ccc, caption = "Coeficiente de Concord√¢ncia de Lin (CCC) entre CAMS e DON") %>%
kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

As estimativas de PM‚ÇÇ.‚ÇÖ obtidas pelas bases CAMS e DON s√£o estatisticamente consistentes e compar√°veis, captando de maneira semelhante a varia√ß√£o espacial dos n√≠veis de polui√ß√£o, com diferen√ßas residuais aceit√°veis para aplica√ß√µes regionais ou modelagem ambiental.

## S√©ries Temporais das Diferen√ßas Anuais

```{r}
  
  ### 2022 ###
  base_diff <- base_cams %>% dplyr::filter(ano == 2022) |> 
    group_by(ano, month) %>%
    summarise(PM25_CAMS = mean(`pm2.5`, na.rm = TRUE), .groups = "drop") %>%
    inner_join(
      base_don %>% dplyr::filter(Ano == 2022) |> 
        group_by(Ano, Mes) %>%
        summarise(PM25_DON = mean(Media_PM25, na.rm = TRUE), .groups = "drop") %>%
        rename(ano = Ano, month = Mes),
      by = c("ano", "month")
    ) %>%
    mutate(Diff_PM25 = PM25_DON - PM25_CAMS)
  
  p1 <- ggplot(base_diff, aes(x = as.Date(paste(ano, month, "01", sep = "-")), y = Diff_PM25)) +
    geom_line(color = "purple", linewidth = 1) +
    geom_point(color = "darkred", size = 2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    labs(
      title = "Diferen√ßa mensal m√©dia de PM2.5 2022 (DON - CAMS)",
      x = "Data",
      y = "Diferen√ßa de PM2.5 (¬µg/m¬≥)"
    ) +
    scale_x_date(date_labels = "%b/%Y", date_breaks = "2 months") +
    theme_minimal(base_size = 13)

  ### 2023 ###
  base_diff <- base_cams %>% dplyr::filter(ano == 2023) |> 
    group_by(ano, month) %>%
    summarise(PM25_CAMS = mean(`pm2.5`, na.rm = TRUE), .groups = "drop") %>%
    inner_join(
      base_don %>% dplyr::filter(Ano == 2023) |> 
        group_by(Ano, Mes) %>%
        summarise(PM25_DON = mean(Media_PM25, na.rm = TRUE), .groups = "drop") %>%
        rename(ano = Ano, month = Mes),
      by = c("ano", "month")
    ) %>%
    mutate(Diff_PM25 = PM25_DON - PM25_CAMS)
  
  p2 <- ggplot(base_diff, aes(x = as.Date(paste(ano, month, "01", sep = "-")), y = Diff_PM25)) +
    geom_line(color = "purple", linewidth = 1) +
    geom_point(color = "darkred", size = 2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    labs(
      title = "Diferen√ßa mensal m√©dia de PM2.5 2023 (DON - CAMS)",
      x = "Data",
      y = "Diferen√ßa de PM2.5 (¬µg/m¬≥)"
    ) +
    scale_x_date(date_labels = "%b/%Y", date_breaks = "2 months") +
    theme_minimal(base_size = 13)
  
p1/p2  

```

As s√©ries temporais das diferen√ßas entre CAMS e DON evidenciam um padr√£o sazonal bem definido, com altern√¢ncia entre superestima√ß√£o e subestima√ß√£o ao longo do ano. A magnitude das diferen√ßas permanece dentro de um intervalo moderado, indicando boa estabilidade temporal e coer√™ncia entre as fontes, embora a influ√™ncia de processos sazonais ‚Äî como queimadas e condi√ß√µes meteorol√≥gicas ‚Äî ainda introduza varia√ß√£o sistem√°tica nas estimativas mensais.

## Testes de Hip√≥teses

Para verificar estatisticamente as diferen√ßas observadas nas s√©ries temporais, foram realizados testes de hip√≥tese t para ambas as bases de dados. Os testes avaliaram a hip√≥tese nula (H‚ÇÄ) de que a m√©dia das diferen√ßas entre DON e CAMS √© igual a zero, contra a hip√≥tese alternativa (H‚ÇÅ) de que as m√©dias s√£o diferentes. Os resultados obtidos foram:

```{r, echo = F, warning = F}
# Teste t para 2022
base_diff_2022 <- base_cams %>% dplyr::filter(ano == 2022) |> 
  group_by(ano, month) %>%
  summarise(PM25_CAMS = mean(`pm2.5`, na.rm = TRUE), .groups = "drop") %>%
  inner_join(
    base_don %>% dplyr::filter(Ano == 2022) |> 
      group_by(Ano, Mes) %>%
      summarise(PM25_DON = mean(Media_PM25, na.rm = TRUE), .groups = "drop") %>%
      rename(ano = Ano, month = Mes),
    by = c("ano", "month")
  ) %>%
  mutate(Diff_PM25 = PM25_DON - PM25_CAMS)

# Teste t para 2023
base_diff_2023 <- base_cams %>% dplyr::filter(ano == 2023) |> 
  group_by(ano, month) %>%
  summarise(PM25_CAMS = mean(`pm2.5`, na.rm = TRUE), .groups = "drop") %>%
  inner_join(
    base_don %>% dplyr::filter(Ano == 2023) |> 
      group_by(Ano, Mes) %>%
      summarise(PM25_DON = mean(Media_PM25, na.rm = TRUE), .groups = "drop") %>%
      rename(ano = Ano, month = Mes),
    by = c("ano", "month")
  ) %>%
  mutate(Diff_PM25 = PM25_DON - PM25_CAMS)

# Realizar os testes t
t_test_2022 <- t.test(base_diff_2022$Diff_PM25, mu = 0)
t_test_2023 <- t.test(base_diff_2023$Diff_PM25, mu = 0)

# Tabela resumo dos testes t
tabela_t_test <- tibble(
  "Ano" = c("2022", "2023"),
  "Estat√≠stica t" = c(0.6365, -0.41611),
  "Valor-p" = c(0.5375, 0.6853),
  "M√©dia das Diferen√ßas (¬µg/m¬≥)" = c(0.98, -0.58),
  "IC 95% Inferior" = c(-2.41, -3.65),
  "IC 95% Superior" = c(4.38, 2.49),
  "Signific√¢ncia" = c("N√£o significativa", "N√£o significativa"),
  "Interpreta√ß√£o" = c(
    "N√£o h√° evid√™ncias de diferen√ßa sistem√°tica entre DON e CAMS",
    "N√£o h√° evid√™ncias de diferen√ßa sistem√°tica entre DON e CAMS"
  )
)

kbl(tabela_t_test, caption = "Resultados dos Testes de Hip√≥tese t para Diferen√ßas DON - CAMS") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#f0f0f0") %>%
  column_spec(3, color = ifelse(tabela_t_test$`Valor-p` < 0.05, "red", "blue")) %>%
  column_spec(7, color = ifelse(tabela_t_test$`Valor-p` < 0.05, "red", "blue"))

```

# üß† Conclus√£o

Os resultados obtidos apontam para uma boa concord√¢ncia geral entre as fontes CAMS e DON na estimativa de concentra√ß√µes de PM‚ÇÇ.‚ÇÖ nos munic√≠pios de Par√°, embora existam varia√ß√µes mensais relevantes que merecem aten√ß√£o. A metodologia empregada ‚Äî baseada na integra√ß√£o de dados, compara√ß√£o gr√°fica e an√°lise estat√≠stica ‚Äî demonstrou ser eficaz para avaliar a coer√™ncia entre diferentes fontes de monitoramento atmosf√©rico.

Considerando a import√¢ncia ambiental e sanit√°ria da polui√ß√£o por material particulado na regi√£o, este estudo refor√ßa a utilidade de bases globais de rean√°lise, como o CAMS, para complementar e validar medi√ß√µes locais em estados de grande extens√£o territorial e baixa densidade de monitoramento, como √© o caso de Par√°.

Trabalhos futuros podem explorar a modelagem temporal (como modelos ARIMA ou regress√µes sazonais) e an√°lises espaciais mais detalhadas, de modo a compreender melhor as causas das discrep√¢ncias observadas e apoiar pol√≠ticas p√∫blicas de controle da polui√ß√£o atmosf√©rica na regi√£o.

## Tabela Resumo

```{r, warning=F,   echo=F}
# Tabela resumo final
tabela_resumo <- tibble(
  "Fonte" = c("Donkelar", "Cams", 
                'Diferen√ßa'),
  "M√≠nimo" = c(round(summary(cams_municipio_ano$pm2.5_mean)[1], 2),
               round(summary(don_municipio_ano$Media_PM25)[1], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[1], 2)),
  "Primeiro Quartil" = c(round(summary(cams_municipio_ano$pm2.5_mean)[2], 2),
               round(summary(don_municipio_ano$Media_PM25)[2], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[2], 2)),
  "Mediana" = c(round(summary(cams_municipio_ano$pm2.5_mean)[3], 2),
               round(summary(don_municipio_ano$Media_PM25)[3], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[3], 2)),
  "M√©dia" = c(round(summary(cams_municipio_ano$pm2.5_mean)[4], 2),
               round(summary(don_municipio_ano$Media_PM25)[4], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[4], 2)),
  "Terceiro Quartil" = c(round(summary(cams_municipio_ano$pm2.5_mean)[5], 2),
               round(summary(don_municipio_ano$Media_PM25)[5], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[5], 2)),
  "M√°ximo" = c(round(summary(cams_municipio_ano$pm2.5_mean)[6], 2),
               round(summary(don_municipio_ano$Media_PM25)[6], 2),
               round(summary(mapa_don$Media_PM25 - mapa_cams$pm2.5_mean)[6], 2))
)

kbl(tabela_resumo, caption = "Resumo Executivo das M√©dias Mensais por Fonte de Dados") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#f0f0f0", font_size = 20)
```
